# 数据库开发规范

## 数据库命名规范
### 前缀
- 对象前缀命名: 前缀命名一般用小写
- 表的前缀: 业务模块组名前缀
- 存储过程前缀: udp ，系统存储过程（sp）
- 自定义函数前缀: udf(User define function)
- 视图前缀: udv(User Define View)表示用户自定义视图
- 自定义约束前缀: uck(User Checker)用户自定义约束
- 索引前缀: idx(Index)表示索引
- 主键前缀: pk(primary keys)表示主键
- 主键前缀: fk(foreign keys)表示主键
### 常见命名约定

- 表名使用单数名<br/>
    例如：对存储客人信息的表（Customer）不使用Customers
- 字段名不要存在无用前缀<br/>
    例如表‘WeiXinConfig’，既然我已经知道这张表是关于微信的表，里面的名称字段可以可以使用Name,不需要添加无用的前缀类似‘WeiXinName’，‘WeiXinGuanZhuMsg’，‘WeiXinUpImgMsg’等
- 避免无谓的表名后缀
    - 表是用来存储数据信息的,表是行的集合。那么如果表名已经能够很好地说明其包含的数据信 息，就不需要再添加体现上面两点的后缀了。
    - GuestInfo(存储客户信息)应写成Guest，FlightList（存储航班信息的表）应写成Flight
- 所有表示时间的字段，统一以 Date 来作为结尾（而不是有的使用Date,有的使用Time）所有表示时间的字段，统一以 Date 来作为结尾（而不是有的使用Date,有的使用Time）

以大家都熟悉的论坛来说，需要记录会员最后一次登录的时间，这时候一般人都会把这个字段命名为LoginTime 或者 LoginDate。这时候，已经产生了一个歧义;如果仅看表的字段名称，不去看表的内容，很容易将LoginTime理解成登录的次数，因为，Time还有一个很常用的意思，就是次数

- 所有表示数目的字段，都应该以Count作为结尾
- 所有代表链接的字段，均为Url结尾
- 所有名称的字符范围为：A-Z, a-z, 0-9 和_(下划线)。不允许使用其他字符作为名称
- 采用英文单词或英文短语（包括缩写）作为名称，不能使用无意义的字符或汉语拼音
- 名称应该清晰明了，能够准确表达事物的含义，最好可读，遵循“见名知意”的原则
- 字段名不能使用保留关键字

## 数据库设计规范
### 主键设计原则
- 主键的数据类型
> 最常见的主键数据类型是数字类型、固定长度的字符类型和GUID类型。通常情况下，RDBMS会在主键上建立聚集索引（SQL Server默认都这么做），由于我们使用B-Tree的数据结构来存储索引数据，所以一般对主键有以下两个要求：

1. 越短越好——越短在一个Page中存储的节点越多，检索速度就越快。
2. 顺序增长——如果每一条插入的数据的主键都比前面的主键大，那么B-Tree上的节点也是顺序增长的，不会造成频繁的B-Tree分割。
越短越好是为了查询的速度快，顺序增长是为了插入速度快。

- 数据库主键与业务主键

建议是不要使用任何有业务含义的字段作主键，而是使用一个自增的（或者系统生成的）没有实际业务意义的字段作为主键。
### 外键设计原则
- 在大型系统中（性能要求不高，安全要求高），使用外键；在大型系统中（性能要求高，安全自己控制），不用外键；小系统随便，最好用外键。
- 用外键要适当，不能过分追求
- 不用外键而用程序控制数据一致性和完整性时，应该写一层来保证，然后个个应用通过这个层来访问数据库。

### 索引设计原则
>  基于合理的数据库设计，经过深思熟虑后为表建立索引，是获得高性能数据库系统的基础。而未经合理分析便添加索引，则会降低系统的总体性能。索引虽然说提高了数据的访问速度，但同时也增加了插入、更新和删除操作的处理时间。<br/>
是否要为表增加索引、索引建立在那些字段上，是创建索引前必须要考虑的问题。解决此问题的一个比较好的方法，就是分析应用程序的业务处理、数据使用，为经常被用作查询条件、或者被要求排序的字段建立索引。基于优化器对SQL语句的优化处理。

我们在创建索引时可以遵循下面的一般性原则：

1. 为经常出现在关键字order by、group by、distinct后面的字段，建立索引。
在这些字段上建立索引，可以有效地避免排序操作。如果建立的是复合索引，索引的字段顺序要和这些关键字后面的字段顺序一致，否则索引不会被使用。
2. 在union等集合操作的结果集字段上，建立索引。其建立索引的目的同上。
3. 为经常用作查询选择的字段，建立索引。
4. 在经常用作表连接的属性上，建立索引。
5. 考虑使用索引覆盖。对数据很少被更新的表，如果用户经常只查询其中的几个字段，可以考虑在这几个字段上建立索引，从而将表的扫描改变为索引的扫描。

*除了以上原则，在创建索引时，我们还应当注意以下的限制：*

1. 限制表上的索引数目。<br/>
对一个存在大量更新操作的表，所建索引的数目一般不要超过3个，最多不要超过5个。索引虽说提高了访问速度，但太多索引会影响数据的更新操作。
2. 不要在有大量相同取值的字段上，建立索引。<br/>
在这样的字段（例如：性别）上建立索引，字段作为选择条件时将返回大量满足条件的记录，优化器不会使用该索引作为访问路径。

3. 避免在取值朝一个方向增长的字段（例如：日期类型的字段）上，建立索引；对复合索引，避免将这种类型的字段放置在最前面。<br/>

    由于字段的取值总是朝一个方向增长，新记录总是存放在索引的最后一个叶页中，从而不断地引起该叶页的访问竞争、新叶页的分配、中间分支页的拆分。此外，如果所建索引是聚集索引，表中数据按照索引的排列顺序存放，所有的插入操作都集中在最后一个数据页上进行，从而引起插入“热点”。
4. 对复合索引，按照字段在查询条件中出现的频度建立索引。

    在复合索引中，记录首先按照第一个字段排序。对于在第一个字段上取值相同的记录，系统再按照第二个字段的取值排序，以此类推。因此只有复合索引的第一个字段出现在查询条件中，该索引才可能被使用。
因此将应用频度高的字段，放置在复合索引的前面，会使系统最大可能地使用此索

5. 删除不再使用，或者很少被使用的索引。

    表中的数据被大量更新，或者数据的使用方式被改变后，原有的一些索引可能不再被需要。数据库管理员应当定期找出这些索引，将它们删除，从而减少索引对更新操作的影响。
## 数据库查询规范
1. 禁止在数据库做复杂运算
2. 禁止使用SELECT
> - 减少内存消耗和网络带宽
> - 给查询优化器有机会从索引读取所需要的列
> - 表结构变化时容易引起查询出错
3. 禁止在索引列上使用函数或计算
> 在where子句中,如果索引是函数的一部分,优化器将不再使用索引而使用全表扫描
4. 禁止使用游标
5. 禁止使用触发器
6. 禁止使用存储过程
7. 变量/参数/关联字段类型必须与字段类型一致
> 避免类型转换额外消耗的CPU，引起的大表scan尤为严重
8. 参数化查询
9. 限制JOIN个数
    1. 单个SQL语句的表JOIN个数不能超过5个
    2. 过多的JOIN个数会导致查询分析器走错执行计划
    3. 过多JOIN在编译执行计划时消耗很大
10. 限制SQL语句长度及IN子句个数<br/>
    在 IN 子句中包括数量非常多的值（数以千计）可能会消耗资源并返回错误 8623 或 8632，要求IN子句中条件个数限制在100个以内
11. 使用UNION ALL替换UNION
    UNION会对SQL结果集去重排序，增加CPU、内存等消耗
12. 查询大量数据使用分页或TOP
    合理限制记录返回数，避免IO、网络带宽出现瓶颈
13. EXISTS替代IN
14. 尽量避免使用OR运算符
    对于OR运算符，通常会使用全表扫描，考虑分解成多个查询用UNION/UNION ALL来实现，这里要确认查询能走到索引并返回较少的结果集
15. 增加事务异常处理机制
16. 输出列使用二段式命名格式
    多表查询 使用别名 查询结果 别名.字段
